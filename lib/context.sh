#!/bin/bash
#═══════════════════════════════════════════════════════════════════════════════
#  CLAUDE CODE WIKI - Context Generator Module
#  Generate intelligent context manifests for AI assistants
#═══════════════════════════════════════════════════════════════════════════════

# Ensure common is loaded
[[ -z "$WIKI_VERSION" ]] && source "$(dirname "${BASH_SOURCE[0]}")/common.sh"

#───────────────────────────────────────────────────────────────────────────────
# Generate project context manifest
#───────────────────────────────────────────────────────────────────────────────

wiki_generate_context() {
    local project_dir="${1:-.}"
    project_dir=$(cd "$project_dir" && pwd)
    local project_name=$(basename "$project_dir")

    wiki_print_header "Generating Context: $project_name"

    # Detect project type
    local project_type=$(wiki_detect_project_type "$project_dir")
    local primary_lang=$(wiki_detect_language "$project_dir")

    wiki_info "Project type: $project_type"
    wiki_info "Primary language: $primary_lang"

    # Choose output format
    local output_file="$project_dir/GEMINI_CONTEXT.md"
    [[ -f "$project_dir/CLAUDE.md" ]] && output_file="$project_dir/CONTEXT.md"

    # Start generating context
    wiki_print_section "Analyzing Structure"

    cat > "$output_file" << EOF
# $project_name Context

> Auto-generated by Claude Code Wiki v$WIKI_VERSION
> Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

## Project Overview

| Property | Value |
|----------|-------|
| Name | $project_name |
| Type | $project_type |
| Language | $primary_lang |
| Path | $project_dir |

## Directory Structure

\`\`\`
$(wiki_generate_tree "$project_dir")
\`\`\`

## Key Files

EOF

    # Add key files section
    wiki_print_section "Identifying Key Files"
    wiki_add_key_files "$project_dir" >> "$output_file"

    # Add dependencies section
    wiki_print_section "Analyzing Dependencies"
    wiki_add_dependencies "$project_dir" "$project_type" >> "$output_file"

    # Add architecture notes
    wiki_print_section "Detecting Architecture"
    wiki_add_architecture "$project_dir" "$project_type" >> "$output_file"

    # Add entry points
    wiki_print_section "Finding Entry Points"
    wiki_add_entry_points "$project_dir" "$project_type" >> "$output_file"

    # Add quick reference
    wiki_add_quick_reference "$project_dir" "$project_type" >> "$output_file"

    echo -e "\n${GREEN}✓${NC} Context generated: $output_file"
    echo -e "  Size: $(wiki_file_size "$output_file") bytes"

    # Update database
    wiki_db_query "UPDATE projects SET has_context = 1 WHERE path = '$project_dir';" 2>/dev/null || true
}

#───────────────────────────────────────────────────────────────────────────────
# Generate tree structure
#───────────────────────────────────────────────────────────────────────────────

wiki_generate_tree() {
    local dir="$1"
    local depth="${2:-3}"

    if command -v tree &> /dev/null; then
        tree -L "$depth" -I 'node_modules|.git|dist|.next|__pycache__|*.pyc|.env*' "$dir" 2>/dev/null | head -50
    else
        # Fallback without tree
        find "$dir" -maxdepth "$depth" -type d \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*" \
            ! -path "*/dist/*" \
            ! -path "*/.next/*" \
            2>/dev/null | head -30 | while read -r d; do
            local indent=$(echo "$d" | sed "s|$dir||" | tr -cd '/' | wc -c | tr -d ' ')
            local name=$(basename "$d")
            printf "%*s%s/\n" $((indent * 2)) "" "$name"
        done
    fi
}

#───────────────────────────────────────────────────────────────────────────────
# Add key files section
#───────────────────────────────────────────────────────────────────────────────

wiki_add_key_files() {
    local dir="$1"

    echo "### Configuration Files"
    echo ""

    for file in package.json tsconfig.json firebase.json next.config.js next.config.mjs \
                requirements.txt pyproject.toml go.mod Cargo.toml Makefile Dockerfile \
                docker-compose.yml .env.example; do
        if [[ -f "$dir/$file" ]]; then
            echo "- \`$file\`"
        fi
    done

    echo ""
    echo "### Entry Points"
    echo ""

    # Find main entry files
    for pattern in "src/index.*" "src/main.*" "src/app.*" "app/page.*" "pages/index.*" \
                   "main.py" "app.py" "main.go" "cmd/main.go" "src/main.rs" "src/lib.rs"; do
        local found=$(find "$dir" -maxdepth 4 -path "*/$pattern" -type f 2>/dev/null | head -3)
        for f in $found; do
            echo "- \`${f#$dir/}\`"
        done
    done

    echo ""
    echo "### Important Directories"
    echo ""

    for subdir in src lib app pages components hooks utils services api routes controllers models; do
        if [[ -d "$dir/$subdir" ]]; then
            local count=$(find "$dir/$subdir" -type f -name "*.ts" -o -name "*.tsx" -o -name "*.js" \
                         -o -name "*.py" -o -name "*.go" 2>/dev/null | wc -l | tr -d ' ')
            echo "- \`$subdir/\` ($count files)"
        fi
    done
    echo ""
}

#───────────────────────────────────────────────────────────────────────────────
# Add dependencies section
#───────────────────────────────────────────────────────────────────────────────

wiki_add_dependencies() {
    local dir="$1"
    local type="$2"

    echo "## Dependencies"
    echo ""

    case "$type" in
        nodejs|typescript|nextjs|firebase)
            if [[ -f "$dir/package.json" ]]; then
                echo "### Production Dependencies"
                echo "\`\`\`json"
                if command -v jq &> /dev/null; then
                    jq -r '.dependencies // {} | keys[]' "$dir/package.json" 2>/dev/null | head -20
                else
                    grep -A 100 '"dependencies"' "$dir/package.json" | grep -E '^\s+"[^"]+":' | head -20 | sed 's/[",:]//g' | awk '{print $1}'
                fi
                echo "\`\`\`"
                echo ""

                echo "### Dev Dependencies"
                echo "\`\`\`json"
                if command -v jq &> /dev/null; then
                    jq -r '.devDependencies // {} | keys[]' "$dir/package.json" 2>/dev/null | head -15
                else
                    grep -A 100 '"devDependencies"' "$dir/package.json" | grep -E '^\s+"[^"]+":' | head -15 | sed 's/[",:]//g' | awk '{print $1}'
                fi
                echo "\`\`\`"
            fi
            ;;
        python|python-modern)
            if [[ -f "$dir/requirements.txt" ]]; then
                echo "### Requirements"
                echo "\`\`\`"
                head -20 "$dir/requirements.txt"
                echo "\`\`\`"
            fi
            if [[ -f "$dir/pyproject.toml" ]]; then
                echo "### pyproject.toml dependencies"
                echo "\`\`\`toml"
                grep -A 30 '\[project.dependencies\]' "$dir/pyproject.toml" 2>/dev/null | head -20
                echo "\`\`\`"
            fi
            ;;
        golang)
            if [[ -f "$dir/go.mod" ]]; then
                echo "### Go Modules"
                echo "\`\`\`"
                grep -E "^\s+\S+\s+v" "$dir/go.mod" | head -20
                echo "\`\`\`"
            fi
            ;;
        rust)
            if [[ -f "$dir/Cargo.toml" ]]; then
                echo "### Cargo Dependencies"
                echo "\`\`\`toml"
                grep -A 30 '\[dependencies\]' "$dir/Cargo.toml" | head -20
                echo "\`\`\`"
            fi
            ;;
    esac
    echo ""
}

#───────────────────────────────────────────────────────────────────────────────
# Add architecture notes
#───────────────────────────────────────────────────────────────────────────────

wiki_add_architecture() {
    local dir="$1"
    local type="$2"

    echo "## Architecture"
    echo ""

    # Detect common patterns
    local patterns=""

    # Check for common architectural patterns
    [[ -d "$dir/src/components" || -d "$dir/components" ]] && patterns+="Component-based UI, "
    [[ -d "$dir/src/hooks" || -d "$dir/hooks" ]] && patterns+="React Hooks, "
    [[ -d "$dir/src/store" || -d "$dir/store" ]] && patterns+="State Management, "
    [[ -d "$dir/src/api" || -d "$dir/api" || -d "$dir/pages/api" ]] && patterns+="API Layer, "
    [[ -d "$dir/src/services" || -d "$dir/services" ]] && patterns+="Service Layer, "
    [[ -d "$dir/src/models" || -d "$dir/models" ]] && patterns+="Data Models, "
    [[ -d "$dir/functions" ]] && patterns+="Cloud Functions, "
    [[ -f "$dir/firebase.json" ]] && patterns+="Firebase Backend, "
    [[ -d "$dir/src/middleware" || -d "$dir/middleware" ]] && patterns+="Middleware, "
    [[ -d "$dir/tests" || -d "$dir/__tests__" || -d "$dir/test" ]] && patterns+="Test Suite, "

    if [[ -n "$patterns" ]]; then
        echo "### Detected Patterns"
        echo "${patterns%, }" | tr ',' '\n' | while read -r p; do
            [[ -n "$p" ]] && echo "- ${p## }"
        done
        echo ""
    fi

    # Framework-specific notes
    case "$type" in
        nextjs)
            echo "### Next.js Structure"
            [[ -d "$dir/app" ]] && echo "- Using App Router (Next.js 13+)"
            [[ -d "$dir/pages" ]] && echo "- Using Pages Router"
            [[ -d "$dir/public" ]] && echo "- Static assets in \`public/\`"
            ;;
        firebase)
            echo "### Firebase Services"
            if [[ -f "$dir/firebase.json" ]]; then
                if command -v jq &> /dev/null; then
                    jq -r 'keys[]' "$dir/firebase.json" 2>/dev/null | while read -r service; do
                        echo "- $service"
                    done
                fi
            fi
            ;;
    esac
    echo ""
}

#───────────────────────────────────────────────────────────────────────────────
# Add entry points
#───────────────────────────────────────────────────────────────────────────────

wiki_add_entry_points() {
    local dir="$1"
    local type="$2"

    echo "## Entry Points"
    echo ""

    case "$type" in
        nodejs|typescript)
            if [[ -f "$dir/package.json" ]]; then
                echo "### NPM Scripts"
                echo "\`\`\`json"
                if command -v jq &> /dev/null; then
                    jq -r '.scripts // {}' "$dir/package.json" 2>/dev/null
                else
                    grep -A 20 '"scripts"' "$dir/package.json" | head -15
                fi
                echo "\`\`\`"
            fi
            ;;
        nextjs|firebase)
            echo "### Development"
            echo "\`\`\`bash"
            echo "npm run dev    # Start development server"
            echo "npm run build  # Build for production"
            echo "npm run start  # Start production server"
            [[ -f "$dir/firebase.json" ]] && echo "firebase deploy # Deploy to Firebase"
            echo "\`\`\`"
            ;;
        python|python-modern)
            echo "### Running"
            echo "\`\`\`bash"
            [[ -f "$dir/main.py" ]] && echo "python main.py"
            [[ -f "$dir/app.py" ]] && echo "python app.py"
            [[ -f "$dir/manage.py" ]] && echo "python manage.py runserver"
            echo "\`\`\`"
            ;;
        golang)
            echo "### Running"
            echo "\`\`\`bash"
            echo "go run ."
            [[ -d "$dir/cmd" ]] && echo "go run ./cmd/..."
            echo "\`\`\`"
            ;;
    esac
    echo ""
}

#───────────────────────────────────────────────────────────────────────────────
# Add quick reference
#───────────────────────────────────────────────────────────────────────────────

wiki_add_quick_reference() {
    local dir="$1"
    local type="$2"

    cat << 'EOF'
## Quick Reference

### For AI Assistants

When working with this project:

1. **Read this context first** before making changes
2. **Check existing patterns** in similar files before creating new ones
3. **Follow the established architecture** - don't introduce new patterns without discussion
4. **Run tests** before committing changes
5. **Update this context** if you make structural changes

### Common Tasks

| Task | Command |
|------|---------|
EOF

    case "$type" in
        nodejs|typescript|nextjs|firebase)
            echo "| Install deps | \`npm install\` |"
            echo "| Run dev | \`npm run dev\` |"
            echo "| Build | \`npm run build\` |"
            echo "| Test | \`npm test\` |"
            echo "| Lint | \`npm run lint\` |"
            ;;
        python|python-modern)
            echo "| Install deps | \`pip install -r requirements.txt\` |"
            echo "| Run | \`python main.py\` |"
            echo "| Test | \`pytest\` |"
            echo "| Lint | \`flake8\` or \`ruff\` |"
            ;;
        golang)
            echo "| Build | \`go build\` |"
            echo "| Run | \`go run .\` |"
            echo "| Test | \`go test ./...\` |"
            echo "| Lint | \`golangci-lint run\` |"
            ;;
    esac

    echo ""
    echo "---"
    echo "*Context auto-generated by [Claude Code Wiki](https://github.com/patrickdellis/claude-code-wiki)*"
}
