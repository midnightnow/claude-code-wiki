#!/bin/bash
#═══════════════════════════════════════════════════════════════════════════════
#  ECOSYSTEM STATUS GENERATOR
#  Generates live status from all services and updates ecosystem.yaml
#═══════════════════════════════════════════════════════════════════════════════

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

ECOSYSTEM_FILE="/Users/studio/claude-code-wiki/docs/ecosystem.yaml"
OUTPUT_FILE="/Users/studio/claude-code-wiki/docs/ECOSYSTEM_STATUS.md"

echo -e "${BOLD}${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BOLD}${CYAN}  HARDCARD ECOSYSTEM STATUS CHECK${NC}"
echo -e "${BOLD}${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "Timestamp: $(date)"
echo ""

# Initialize output file
cat > "$OUTPUT_FILE" << 'HEADER'
# Hardcard Ecosystem Status
> Auto-generated status report

**Last Updated:** TIMESTAMP

---

## Service Health

| Service | Status | URL |
|---------|--------|-----|
HEADER

# Replace timestamp
sed -i '' "s/TIMESTAMP/$(date)/" "$OUTPUT_FILE"

# Function to check URL health
check_health() {
    local name="$1"
    local url="$2"
    local endpoint="${3:-}"

    if [ -n "$endpoint" ]; then
        full_url="$url$endpoint"
    else
        full_url="$url"
    fi

    response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$full_url" 2>/dev/null || echo "000")

    if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
        echo -e "| $name | ${GREEN}✓ UP${NC} | $url |" >> "$OUTPUT_FILE"
        echo -e "  ${GREEN}✓${NC} $name: UP (HTTP $response)"
        return 0
    else
        echo -e "| $name | ${RED}✗ DOWN${NC} | $url |" >> "$OUTPUT_FILE"
        echo -e "  ${RED}✗${NC} $name: DOWN (HTTP $response)"
        return 1
    fi
}

# Check all services
echo -e "${YELLOW}Checking frontend services...${NC}"
check_health "VetSorcery Frontend" "https://vetsorcery.com" || true
check_health "AIVA Help Frontend" "https://aiva.help" || true
check_health "Influential Digital" "https://influential.digital" || true
check_health "Business Basics" "https://businessbasics.site" || true

echo ""
echo -e "${YELLOW}Checking backend services...${NC}"
check_health "VetSorcery Backend" "https://hardcard-vetsorcery.onrender.com" "/health" || true
check_health "AIVA Functions" "https://us-central1-influential-digital-2025.cloudfunctions.net/health" "" || true

# Add status summary
cat >> "$OUTPUT_FILE" << 'BLOCKERS'

---

## System Status Summary

### Security Audit (2025-12-03)
- **Status:** ✅ PASSED (11/11 checks)
- **CORS:** Restricted to whitelist
- **Headers:** CSP, X-Frame-Options, HSTS configured
- **Verification:** Run `scripts/verify-security.sh`

### Outstanding Items (Non-blocking)
| Item | Severity | Status |
|------|----------|--------|
| GHL Token 403 | LOW | CRM sync disabled |
| Google Ads IDs | LOW | Placeholder until campaigns |
| Gen 1 health function | INFO | Technical debt only |

---

## Quick Commands

```bash
# Verify security (AIVA)
/Users/studio/aiva-help-deploy/scripts/verify-security.sh

# Ecosystem status
/Users/studio/claude-code-wiki/scripts/ecosystem-status.sh

# Audit Firebase projects
/Users/studio/claude-code-wiki/scripts/firebase-audit.sh
```

---

## Revenue Summary

| Project | Status | Potential MRR |
|---------|--------|---------------|
| VetSorcery | DEPLOYED | $10,000 |
| AIVA Help | OPERATIONAL | $5,000 |
| Influential Digital | READY | $3,000 |
| Business Basics | ACTIVE | $2,000 |
| **Total** | | **$20,000** |

---

*Generated by ecosystem-status.sh*
BLOCKERS

echo ""
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  STATUS CHECK COMPLETE${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "Report saved to: ${CYAN}$OUTPUT_FILE${NC}"
echo ""

# Summary counts
echo -e "${BOLD}Summary:${NC}"
TOTAL_UP=$(grep -c "UP" "$OUTPUT_FILE" 2>/dev/null | tr -d '\n' || echo "0")
TOTAL_DOWN=$(grep -c "DOWN" "$OUTPUT_FILE" 2>/dev/null | tr -d '\n' || echo "0")
echo -e "  Services UP: ${GREEN}$TOTAL_UP${NC}"
echo -e "  Services DOWN: ${RED}$TOTAL_DOWN${NC}"
echo ""

# Next action
if [ "$TOTAL_DOWN" -gt 0 ]; then
    echo -e "${BOLD}Priority Action:${NC}"
    echo -e "  Check down services and redeploy if needed"
else
    echo -e "${BOLD}Status:${NC}"
    echo -e "  ${GREEN}All services operational - ready for sales!${NC}"
fi
echo ""
